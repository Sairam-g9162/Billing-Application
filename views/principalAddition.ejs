<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Principal Addition</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* Only adding styles that aren't in your styles.css */
    .search-form {
      margin-bottom: 20px;
      text-align: left;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .principal-history {
      margin: 20px 0;
    }
    .principal-form {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Principal Addition</h1>
    <a href="/" class="back-button">Home</a>

    <!-- Bill Search Form -->
    <div class="search-form">
      <form method="GET" action="/principal-addition">
        <div>
          <label for="billNumber">Enter Bill Number:</label>
          <input type="text" id="billNumber" name="billNumber" value="<%= locals.searchBillNumber || '' %>" required>
        </div>
        <button type="submit">Get Details</button>
      </form>
    </div>
    <button class="top-right-button" onclick="window.location.href='/find-bill'">Find Bill ?</button>
    <!-- Display error message -->
    <% if (locals.error) { %>
      <p style="color: red;"><%= error %></p>
    <% } %>

    <!-- Display bill details -->
    <% if (locals.bill) { %>
      <div class="bill-card">
        <div class="bill-card-content">
          <h3>Bill Number: <%= bill["Bill Number"] %></h3>
          <p><strong>Name:</strong> <%= bill["Name"] %></p>
          <p><strong>Initial Pledged Amount:</strong> <%= bill["Initial Pledged Amount"] %></p>
          <p><strong>Pledged Date:</strong> <%= bill['Date']%></p>
          
          <!-- Display Principal Addition History in a table -->
          <div class="principal-history">
            <h4><gradient-wrapper>Principal Addition History</gradient-wrapper></h4>
            <% 
            let principalHistory = {};
            if (bill["Principle_Adding_His"]) {
              try {
                principalHistory = JSON.parse(bill["Principle_Adding_His"]);
              } catch(e) {
                // If not valid JSON, display error
                principalHistory = {};
              }
            }
            %>
            
            <% if (Object.keys(principalHistory).length > 0) { %>
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <% Object.entries(principalHistory).forEach(([date, amount]) => { %>
                    <tr>
                      <td><%= date %></td>
                      <td><%= amount %></td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            <% } else { %>
              <p>No principal addition history found</p>
            <% } %>
          </div>
          
          <!-- Principal Addition Form -->
          <div class="principal-form">
            <h4><gradient-wrapper>Add Principal Amount</gradient-wrapper></h4>
            <form id="principalForm">
              <input type="hidden" id="formBillNumber" value="<%= bill['Bill Number'] %>">
              <input type="hidden" id="formName" value="<%= bill['Name'] %>">
              
              <div>
                <label for="addDate">Date:</label>
                <input type="date" id="addDate" required>
              </div>
              
              <div>
                <label for="addAmount">Amount:</label>
                <input type="number" id="addAmount" required>
              </div>
              
              <button type="button" onclick="previewAddition()">Preview</button>
            </form>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Back to Home Button -->
    <button class="back-button-form" onclick="window.location.href='/'">Back to Home Page</button>
  </div>
  
  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <div class="modal-left">
        <h3><gradient-wrapper>Confirm Principal Addition</gradient-wrapper></h3>
        <p><strong>Bill Number:</strong> <span id="confirmBillNumber"></span></p>
        <p><strong>Name:</strong> <span id="confirmName"></span></p>
        <p><strong>Date:</strong> <span id="confirmDate"></span></p>
        <p><strong>Amount:</strong> <span id="confirmAmount"></span></p>
      </div>
      <div class="modal-buttons">
        <button onclick="confirmAndSubmit()">Confirm & Submit</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Success Animation Modal -->
  <div id="successModal" class="success-modal">
    <div class="success-content">
      <div class="checkmark-circle">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      </div>
      <p>Principal amount added successfully!</p>
    </div>
  </div>
  
  <script>
    // Set today's date as default
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('addDate')) {
        const today = new Date();
        const formattedDate = today.toISOString().substr(0, 10);
        document.getElementById('addDate').value = formattedDate;
      }
    });
    
    // Preview function
    function previewAddition() {
      const billNumber = document.getElementById('formBillNumber').value;
      const name = document.getElementById('formName').value;
      const date = document.getElementById('addDate').value;
      const amount = document.getElementById('addAmount').value;
      
      if (!date || !amount) {
        alert('Please fill in all fields');
        return;
      }
      
      // Format date for display (DD-MM-YYYY)
      const dateParts = date.split('-');
      const formattedDate = dateParts[2] + '-' + dateParts[1] + '-' + dateParts[0];
      
      // Fill in confirmation modal
      document.getElementById('confirmBillNumber').textContent = billNumber;
      document.getElementById('confirmName').textContent = name;
      document.getElementById('confirmDate').textContent = formattedDate;
      document.getElementById('confirmAmount').textContent = amount;
      
      // Show modal
      document.getElementById('confirmationModal').style.display = 'block';
    }
    
    // Close modal
    function closeModal() {
      document.getElementById('confirmationModal').style.display = 'none';
    }
    
    // Show success animation
    function showSuccessAnimation() {
      const successModal = document.getElementById('successModal');
      successModal.style.display = 'flex';
      
      // Hide after 2 seconds
      setTimeout(function() {
        successModal.style.display = 'none';
        window.location.reload();
      }, 2000);
    }
    
    // Confirm and submit
    function confirmAndSubmit() {
      const billNumber = document.getElementById('formBillNumber').value;
      const date = document.getElementById('addDate').value;
      const amount = document.getElementById('addAmount').value;
      
      // Format date for storage (DD-MM-YYYY)
      const dateParts = date.split('-');
      const formattedDate = dateParts[2] + '-' + dateParts[1] + '-' + dateParts[0];
      
      // Send data to server
      fetch('/add-principal', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          billNumber: billNumber,
          date: formattedDate,
          amount: amount
        }),
      })
      .then(response => response.json())
      .then(data => {
        closeModal();
        if (data.success) {
          showSuccessAnimation();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        closeModal();
        alert('Error: ' + error.message);
      });
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('confirmationModal');
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>